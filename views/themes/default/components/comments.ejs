<%
  // 评论组件参数：
  // - comments: 评论数据数组
  // - videoId: 视频ID（用于提交新评论）
  // - currentUser: 当前用户信息（可选）
  
  const comments = locals.comments || [];
  const videoId = locals.videoId || '';
  const currentUser = locals.currentUser || null;
%>

<div class="comments-container">
  <!-- 评论统计 -->
  <div class="comments-header">
    <h3 class="comments-title">
      <svg viewBox="0 0 24 24" class="comments-icon">
        <path d="M21,6H3A1,1 0 0,0 2,7V17A1,1 0 0,0 3,18H9L12,21L15,18H21A1,1 0 0,0 22,17V7A1,1 0 0,0 21,6M13,14H11V12H13V14M13,10H11V8H13V10Z"/>
      </svg>
      评论 (<%= comments.length %>)
    </h3>
  </div>

  <!-- 评论输入框 -->
  <div class="comment-form-container">
    <% if (currentUser) { %>
      <div class="comment-form">
        <div class="comment-avatar">
          <% if (currentUser.avatar) { %>
            <img src="<%= currentUser.avatar %>" alt="<%= currentUser.displayName %>" class="avatar-img">
          <% } else { %>
            <div class="avatar-fallback">
              <%= currentUser.displayName.charAt(0).toUpperCase() %>
            </div>
          <% } %>
        </div>
        <div class="comment-input-wrapper">
          <textarea 
            class="comment-input" 
            placeholder="添加评论..." 
            rows="1"
            data-video-id="<%= videoId %>"
          ></textarea>
          <div class="comment-actions">
            <button class="btn-cancel" style="display: none;">取消</button>
            <button class="btn-submit" disabled>评论</button>
          </div>
        </div>
      </div>
    <% } else { %>
      <div class="comment-login-prompt">
        <p>请 <a href="/login">登录</a> 后发表评论</p>
      </div>
    <% } %>
  </div>

  <!-- 评论列表 -->
  <div class="comments-list">
    <% if (comments && comments.length > 0) { %>
      <% comments.forEach(function(comment) { %>
        <div class="comment-item" data-comment-id="<%= comment.id %>">
          <!-- 用户头像 -->
          <div class="comment-avatar">
            <a href="/users/<%= comment.author.id %>">
              <% if (comment.author.avatar) { %>
                <img src="<%= comment.author.avatar %>" alt="<%= comment.author.displayName %>" class="avatar-img">
              <% } else { %>
                <div class="avatar-fallback">
                  <%= comment.author.displayName.charAt(0).toUpperCase() %>
                </div>
              <% } %>
            </a>
          </div>
          
          <!-- 评论内容 -->
          <div class="comment-content">
            <div class="comment-header">
              <div class="comment-author">
                <a href="/users/<%= comment.author.id %>" class="author-name">
                  <%= comment.author.displayName %>
                  <% if (comment.author.verified) { %>
                    <span class="verified-badge">✓</span>
                  <% } %>
                </a>
                <span class="comment-time"><%= comment.formattedTime %></span>
              </div>
              <div class="comment-menu">
                <button class="menu-btn" data-comment-id="<%= comment.id %>">
                  <svg viewBox="0 0 24 24">
                    <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                  </svg>
                </button>
              </div>
            </div>
            
            <div class="comment-text">
              <%= comment.content %>
            </div>
            
            <div class="comment-actions">
              <button class="action-btn like-btn" data-comment-id="<%= comment.id %>">
                <svg viewBox="0 0 24 24" class="action-icon">
                  <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
                <span class="like-count"><%= comment.likeCount || 0 %></span>
              </button>
              
              <button class="action-btn dislike-btn" data-comment-id="<%= comment.id %>">
                <svg viewBox="0 0 24 24" class="action-icon">
                  <path d="M19 15l-6 6-1.42-1.42L15.17 16H4V4h2v10h9.17l-3.59-3.58L13 9l6 6z"/>
                </svg>
              </button>
              
              <button class="action-btn reply-btn" data-comment-id="<%= comment.id %>">
                回复
              </button>
            </div>
            
            <!-- 回复列表 -->
            <% if (comment.replies && comment.replies.length > 0) { %>
              <div class="replies-container">
                <% comment.replies.forEach(function(reply) { %>
                  <div class="reply-item" data-reply-id="<%= reply.id %>">
                    <div class="comment-avatar">
                      <a href="/users/<%= reply.author.id %>">
                        <% if (reply.author.avatar) { %>
                          <img src="<%= reply.author.avatar %>" alt="<%= reply.author.displayName %>" class="avatar-img">
                        <% } else { %>
                          <div class="avatar-fallback">
                            <%= reply.author.displayName.charAt(0).toUpperCase() %>
                          </div>
                        <% } %>
                      </a>
                    </div>
                    <div class="comment-content">
                      <div class="comment-header">
                        <div class="comment-author">
                          <a href="/users/<%= reply.author.id %>" class="author-name">
                            <%= reply.author.displayName %>
                            <% if (reply.author.verified) { %>
                              <span class="verified-badge">✓</span>
                            <% } %>
                          </a>
                          <span class="comment-time"><%= reply.formattedTime %></span>
                        </div>
                      </div>
                      <div class="comment-text">
                        <% if (reply.replyTo) { %>
                          <span class="reply-to">@<%= reply.replyTo %></span>
                        <% } %>
                        <%= reply.content %>
                      </div>
                      <div class="comment-actions">
                        <button class="action-btn like-btn" data-reply-id="<%= reply.id %>">
                          <svg viewBox="0 0 24 24" class="action-icon">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                          </svg>
                          <span class="like-count"><%= reply.likeCount || 0 %></span>
                        </button>
                        <button class="action-btn reply-btn" data-comment-id="<%= comment.id %>" data-reply-to="<%= reply.author.displayName %>">
                          回复
                        </button>
                      </div>
                    </div>
                  </div>
                <% }); %>
              </div>
            <% } %>
          </div>
        </div>
      <% }); %>
    <% } else { %>
      <div class="no-comments">
        <div class="no-comments-message">
          <svg viewBox="0 0 24 24" class="no-comments-icon">
            <path d="M21,6H3A1,1 0 0,0 2,7V17A1,1 0 0,0 3,18H9L12,21L15,18H21A1,1 0 0,0 22,17V7A1,1 0 0,0 21,6M13,14H11V12H13V14M13,10H11V8H13V10Z"/>
          </svg>
          <h4>还没有评论</h4>
          <p>成为第一个发表评论的人吧！</p>
        </div>
      </div>
    <% } %>
  </div>
</div>